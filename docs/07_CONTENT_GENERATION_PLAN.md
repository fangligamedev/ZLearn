# 自定义课程生成改进方案（基于 zeabur.com/docs/zh-CN）

目标：在不滥用 LLM 的前提下，自动抓取站点导航 → 结构化 Markdown（按页面/章节边界）→ 基于章节生成地图/关卡与题目，保持知识点语义一致，效果类似 DeepWiki。

## 方案概览
1) 导航抓取（可配置深度/链接数）  
   - 默认从入口 URL 抓取导航树（侧边栏/目录），识别同域链接。  
   - 深度、最大子链接数可配置（如 depth=2，maxLinks=50），用户可在 UI 配置。  
   - 仅同域/同前缀，过滤二进制/大文件，避免跑偏。

2) 页面级 Markdown 提取（保持章节边界）  
   - 对每个选中链接，抓取全文 Markdown（r.jina.ai 或自建代理），不拆散页面。  
   - 清理：去除脚注/代码块/广告；保留标题层级（H1-H4）。  
   - 生成一份中间 Markdown 存档（按页面命名），供后续审阅与复用。  
   - 汇总时保留页面顺序与层级，便于映射地图/关卡。

3) 地图/关卡分配（按导航层级映射）  
   - 地图对应一级/二级目录（例：M1 平台概览、M2 计费与配额…）。  
   - 关卡对应页面内的 H2/H3 段（或整个页面若层级简单）。  
   - 每个关卡携带上下文：所属地图、章节标题、正文摘要。

4) 题目生成（LLM 目标收敛、节省 Token）  
   - 对每个关卡，抽取最多 N 段核心文本（如 800-1200 字），发送单次 LLM 请求，生成 1-3 道题。  
   - Prompt 控制：输出严格 JSON、指定题型分布（单选/判断/填空），限制字数，要求给出标题/难度。  
   - 若关卡数多，可批量请求：一个地图内的若干关卡合并一批，避免每关一请求。

5) 失败与回退  
   - 抓取失败：提示用户检查 URL 或增大链接上限。  
   - LLM 失败：直接报错，不再兜底本地题目；可重试或调低地图/关卡数量。

## 配置项（建议暴露到 UI）
- 起始 URL（默认 https://zeabur.com/docs/zh-CN）
- 同域深度 depth（默认 2），最大链接 maxLinks（默认 50，可手输）
- 地图/关卡模式：按导航层级映射（默认），可选“均分”备选
- 题目配置：题型列表、每关题目数（1-3）、单次摘要字数上限

## 实现步骤（代码改动点）
1) 新增 crawler 服务（参考 docs/02_TECHNICAL_ARCHITECTURE.md 第14节思路）：  
   - 输入：起始 URL、depth、maxLinks。  
   - 输出：页面列表 [{ url, title, markdown }]，保持导航顺序。  
   - 仅抓取同域/同前缀；抽取页面标题（H1/H2）作为 map/level 参考。

2) Markdown 归档  
   - 将每个页面的清洗后 Markdown 写入中间存储（内存/临时文件/IndexedDB），便于调试。  
   - 清洗规则：去代码块/脚注/多余空白，保留标题与正文。

3) 关卡生成器改造  
   - 输入页面列表，根据标题层级分配 map/level：  
     * Map = 一级目录/页面分组；Level = 页面内 H2/H3 段或整页。  
   - 为每个 Level 准备 `context`（标题、所属 Map、正文摘要）。  
   - 调用 LLM：按关卡批量（如每批 3-5 关）生成题目 JSON，限制 Token。

4) 错误处理与提示  
   - 抓取/LLM 失败时在 UI 显示明确错误（HTTP code/超时等），引导重试或降低规模。  
   - 允许用户调小 depth/maxLinks 以加速。

## 预期效果
- 地图/关卡命名与官网导航一致，语义清晰。  
- 题目基于章节内容生成，减少长串无意义文本。  
- LLM 调用次数减少（批量关卡、一批摘要），Token 成本可控。

## 对话确认（执行方向）
1) 抓取使用 `https://r.jina.ai/`，无需配置 Key。  
2) 新增 crawler 服务：扫描导航并在 UI 中让用户勾选需要的页面。  
3) UI 支持选择/确认页面列表，并可导出抓取到的 Markdown（按页面保留）。  
确认后按此方案实施。 
